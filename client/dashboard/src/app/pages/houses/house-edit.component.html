<div class="edit-shell" (click)="$event.stopPropagation()">
  <div class="glass-panel">
    <header class="header">
      <h3>
        {{ id ? ('HOUSES.EDIT_TITLE' | translate) : ('HOUSES.CREATE_TITLE' | translate) }}
      </h3>
    </header>

    @if (form()) {
      <form class="form" (submit)="save($event)">
        <section class="form-grid top">
          <label>
            <span class="label-text">{{ 'HOUSES.NAME' | translate }}</span>
            <input
              type="text"
              name="name"
              autocomplete="off"
              [value]="form()?.name"
              (input)="updateField('name', $any($event.target).value)"
              required
            />
          </label>

          <label class="description">
            <span class="label-text">{{ 'HOUSES.DESCRIPTION' | translate }}</span>
            <textarea
              name="description"
              rows="3"
              [value]="form()?.description"
              (input)="updateField('description', $any($event.target).value)"
            ></textarea>
          </label>

          <label class="combobox">
            <span class="label-text">{{ 'HOUSES.TYPE' | translate }}</span>
            <sf-dropdown
              [items]="houseTypeOptions()"
              [value]="form()?.houseTypeName ?? ''"
              (selectionChange)="updateField('houseTypeName', $event)"
              placeholder="{{ 'HOUSES.SELECT_TYPE' | translate }}"
              name="houseTypeName"
            ></sf-dropdown>

            @if (houseTypes.loading()) {
              <p class="mini-note">{{ 'HOUSES.LOADING_TYPES' | translate }}</p>
            }
            @if (houseTypes.error()) {
              <p class="status error">{{ houseTypes.error() }}</p>
            }
          </label>
        </section>

        <section class="form-grid listing">
          <div class="listing-type" role="radiogroup" aria-label="{{ 'HOUSES.LISTING_TYPE' | translate }}">
            <span class="label-text">{{ 'HOUSES.LISTING_TYPE' | translate }}</span>
            <div class="listing-options">
              @for (option of listingTypeOptions; track option.value) {
                <label class="listing-option">
                  <input
                    type="radio"
                    name="listingType"
                    [checked]="form()?.listingType === option.value"
                    (change)="updateField('listingType', option.value)"
                  />
                  <span>{{ option.labelKey | translate }}</span>
                </label>
              }
            </div>
          </div>

          <label>
            <span class="label-text">{{ 'HOUSES.PRICE' | translate }}</span>
            <input
              type="number"
              inputmode="decimal"
              step="0.01"
              min="0"
              name="price"
              [value]="form()?.price ?? 0"
              (input)="updateField('price', parseNumber($any($event.target).value))"
              required
            />
          </label>

          <label class="combobox">
            <span class="label-text">{{ 'HOUSES.CURRENCY' | translate }}</span>
            <sf-dropdown
              [items]="currencyOptions()"
              [value]="form()?.currency ?? ''"
              (selectionChange)="updateField('currency', $event)"
              placeholder="{{ 'HOUSES.SELECT_CURRENCY' | translate }}"
              name="currency"
            ></sf-dropdown>
          </label>
        </section>

        <section class="form-grid address">
          <label>
            <span class="label-text">{{ 'HOUSES.ADDRESS_LINE_1' | translate }}</span>
            <input
              type="text"
              name="line1"
              autocomplete="off"
              [value]="form()?.line1"
              (input)="updateField('line1', $any($event.target).value)"
              required
            />
          </label>

          <label>
            <span class="label-text">{{ 'HOUSES.ADDRESS_LINE_2' | translate }}</span>
            <input
              type="text"
              name="line2"
              autocomplete="off"
              [value]="form()?.line2"
              (input)="updateField('line2', $any($event.target).value)"
            />
          </label>

          <label>
            <span class="label-text">{{ 'HOUSES.CITY' | translate }}</span>
            <input
              type="text"
              name="city"
              autocomplete="off"
              [value]="form()?.city"
              (input)="updateField('city', $any($event.target).value)"
              required
            />
          </label>

          <label>
            <span class="label-text">{{ 'HOUSES.REGION' | translate }}</span>
            <input
              type="text"
              name="region"
              autocomplete="off"
              [value]="form()?.region"
              (input)="updateField('region', $any($event.target).value)"
            />
          </label>

          <label class="combobox">
            <span class="label-text">{{ 'HOUSES.COUNTRY' | translate }}</span>
            <sf-dropdown
              [items]="countryOptions()"
              [value]="form()?.country ?? ''"
              (selectionChange)="updateField('country', $event)"
              placeholder="{{ 'HOUSES.SELECT_COUNTRY' | translate }}"
              name="country"
            ></sf-dropdown>

            @if (loadingCountries()) {
              <p class="mini-note">{{ 'HOUSES.LOADING_COUNTRIES' | translate }}</p>
            }
            @if (countriesError()) {
              <p class="mini-note status error">{{ countriesError() }}</p>
            }
          </label>

          <label>
            <span class="label-text">{{ 'HOUSES.POSTAL_CODE' | translate }}</span>
            <input
              type="text"
              name="postalCode"
              autocomplete="off"
              [value]="form()?.postalCode"
              (input)="updateField('postalCode', $any($event.target).value)"
            />
          </label>
        </section>

        <div class="fileupload-row">
          <sf-fileupload
            label="{{ 'HOUSES.PHOTOS' | translate }}"
            accept="image/*"
            [multiple]="true"
            [disabled]="uploading() || saving()"
            (filesSelected)="onFileSelected($event)"
          ></sf-fileupload>
        </div>

        @if ((form()?.photos?.length ?? 0) > 0) {
          <section class="photos">
            <div class="photo-list">
              @for (photo of form()?.photos; track trackPhoto($index, photo); let i = $index) {
                <div class="photo-item">
                  <div class="photo-thumb">
                    <img
                      [src]="photo.kind === 'existing' ? photo.url : photo.previewUrl"
                      [alt]="photo.label"
                      loading="lazy"
                    />
                  </div>
                  <div class="photo-info">
                    <strong>{{ photo.label }}</strong>
                  </div>
                  <button class="text-button" type="button" (click)="removePhoto(i)">
                    {{ 'HOUSES.REMOVE_PHOTO' | translate }}
                  </button>
                </div>
              }
            </div>
          </section>
        }
        @else {
          <p class="no-photos">{{ 'HOUSES.NO_PHOTOS' | translate }}</p>
        }

        <section class="actions">
          <button type="button" class="btn ghost" (click)="cancel()" [disabled]="saving()">
            {{ 'COMMON.CANCEL' | translate }}
          </button>
          <button type="submit" class="btn primary" [disabled]="saving()">
            {{
              saving()
                ? ('COMMON.SAVING' | translate)
                : (id ? ('COMMON.UPDATE' | translate) : ('COMMON.CREATE' | translate))
            }}
          </button>
        </section>
      </form>
    }

    <div class="status-bar">
      @if (error()) {
        <span class="status error">{{ error() }}</span>
      }
      @if (saved()) {
        <span class="status success">{{ 'HOUSES.SAVED' | translate }}</span>
      }
    </div>
  </div>
</div>
