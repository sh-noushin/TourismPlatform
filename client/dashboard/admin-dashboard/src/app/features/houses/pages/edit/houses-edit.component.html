<sf-card class="houses-edit-card">
  <div class="houses-edit">
    <sf-page-header
      [title]="isEdit() ? 'Edit house' : 'Create house'"
      [subtitle]="isEdit() ? 'Update property details' : 'Add a new property'"
    >
      <div header-actions>
        <sf-button variant="ghost" size="sm" (click)="goBack()">Back</sf-button>
      </div>
    </sf-page-header>

    <form [formGroup]="form" (ngSubmit)="save()">
      <section class="houses-edit__section">
        <h3>General</h3>
        <div class="houses-edit__grid">
          <sf-form-field label="Name" [forId]="'name'" [error]="form.controls.name.touched && form.controls.name.invalid ? 'Required' : null">
            <input id="name" type="text" formControlName="name" />
          </sf-form-field>
          <sf-form-field label="Type" [forId]="'houseTypeName'" [error]="form.controls.houseTypeName.touched && form.controls.houseTypeName.invalid ? 'Required' : null">
            <input id="houseTypeName" type="text" formControlName="houseTypeName" />
          </sf-form-field>
          <sf-form-field label="Description" [forId]="'description'">
            <input id="description" type="text" formControlName="description" />
          </sf-form-field>
        </div>
      </section>

      <section class="houses-edit__section">
        <h3>Address</h3>
        <div class="houses-edit__grid houses-edit__grid--address">
          <sf-form-field label="Line 1" [forId]="'line1'" [error]="form.controls.address.controls.line1.touched && form.controls.address.controls.line1.invalid ? 'Required' : null">
            <input id="line1" type="text" formControlName="line1" />
          </sf-form-field>
          <sf-form-field label="Line 2" [forId]="'line2'">
            <input id="line2" type="text" formControlName="line2" />
          </sf-form-field>
          <sf-form-field label="City" [forId]="'city'" [error]="form.controls.address.controls.city.touched && form.controls.address.controls.city.invalid ? 'Required' : null">
            <input id="city" type="text" formControlName="city" />
          </sf-form-field>
          <sf-form-field label="Region" [forId]="'region'">
            <input id="region" type="text" formControlName="region" />
          </sf-form-field>
          <sf-form-field label="Country" [forId]="'country'" [error]="form.controls.address.controls.country.touched && form.controls.address.controls.country.invalid ? 'Required' : null">
            <input id="country" type="text" formControlName="country" />
          </sf-form-field>
          <sf-form-field label="Postal Code" [forId]="'postalCode'">
            <input id="postalCode" type="text" formControlName="postalCode" />
          </sf-form-field>
        </div>
      </section>

      <section class="houses-edit__section houses-edit__photos">
        <div class="photos__header">
          <h3>Photos</h3>
          <label class="file-uploader">
            <input type="file" multiple (change)="onFileInputChange($event)" />
            <sf-button variant="outline" size="sm" type="button">Stage files</sf-button>
          </label>
        </div>

        <div class="photos__container">
          <div class="photos__existing">
            @for (photo of existingPhotos(); track photo.photoId) {
              <div class="photo">
                <img [src]="facade.buildTempFileUrl(photo.permanentRelativePath)" alt="{{ photo.label }}" />
                <div>
                  <p>{{ photo.label }}</p>
                  <span>Sort {{ photo.sortOrder }}</span>
                </div>
                <sf-button variant="ghost" size="sm" (click)="removeExisting(photo.photoId)">
                  Remove
                </sf-button>
              </div>
            }
            @if (!existingPhotos().length) {
              <sf-empty-state
                title="No saved photos"
                description="Stage uploads to add them to the house"
              />
            }
          </div>

          <div class="photos__staged">
            <h4>Staged uploads</h4>
            @for (item of staged(); track item.stagedUploadId; let i = $index) {
              <div class="staged">
                <img [src]="item.previewUrl" alt="{{ item.label }}" width="80" height="60" />
                <sf-form-field label="Label">
                  <input
                    type="text"
                    [value]="item.label"
                    (input)="updateStagedLabel(i, $any($event.target).value)"
                  />
                </sf-form-field>
                <sf-form-field label="Sort">
                  <input
                    type="number"
                    [value]="item.sortOrder"
                    (input)="updateStagedSort(i, $any($event.target).value)"
                  />
                </sf-form-field>
                <sf-button variant="ghost" size="sm" (click)="removeStaged(i)">
                  Remove
                </sf-button>
              </div>
            }
            @if (!staged().length) {
              <sf-empty-state
                title="No staged photos"
                description="Uploads appear here before saving"
              />
            }
          </div>
        </div>
      </section>

      <div class="houses-edit__actions">
        <sf-button type="submit" [loading]="loading()">Save house</sf-button>
      </div>
    </form>
  </div>
</sf-card>
